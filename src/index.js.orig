#!/usr/bin/env node
const Lorena = require('@lorena-ssi/lorena-sdk').default
const Wallet = require('@lorena-ssi/wallet-lib').default

const createWallet = require('./createWallet')
const term = require('./term')
const Commander = require('./Commander')

// Main.
const main = async () => {
  await term.banner('Lorena', 'An awesome framework for Self-Sovereign Identity')
  // Username & password.
  const username = await term.input('Username')
  const password = await term.input('Password')

  // Open Wallet and connect to Lorena
  const wallet = new Wallet(username)
  const lorena = new Lorena(wallet, { debug: true, silent: true })

  // Open the Wallet. Create a new one if no wallet available.
  if (await lorena.unlock(password)) {
    term.info('Wallet open')
    await lorena.connect()
  } else if (await term.yesOrNo('Wallet does not exist. Create a new wallet?')) {
    await createWallet(lorena, wallet, password)
    await lorena.connect()
  } else process.exit()

  // React to messages received.
  lorena.on('message:action-post', async (payload) => term.message('Received action', payload))
  lorena.on('contact-incoming', async (payload) => term.message('Contact invitation Incoming from', payload))
  lorena.on('contact-added', async (payload) => term.message('Contact invitation Accepted from', payload))
  lorena.on('error', (e) => term.error(e))
  lorena.on('ready', async () => {
    term.info('Lorena ^+connected^')
    await term.ctrlC(lorena)
<<<<<<< HEAD
    const commander = new Commander(lorena)
    commander.run()
  })
}
=======
    terminal(lorena, wallet)
  })
}

/**
 * Opens the terminal
 *
 * @param {object} lorena Lorena Object
 * @param {object} wallet Local information (wallet)
 */
function terminal (lorena, wallet) {
  const history = []
  const autoComplete = [
    'help', 'info',
    'link', 'link-pubkey',
    'links', 'link-add',
    'link-ping', 'link-ping-admin',
    'link-member-of', 'link-member-of-confirm', 'link-member-list',
    'link-action-issue', 'link-action-update', 'link-credential-add',
    'link-credential-get', 'link-credential-issue', 'link-credential-issued',
    'link-credential-list', 'credential', 'credentials',
    'action-issue', 'save', 'exit']
  term.lorena()
  term.inputField({ history, autoComplete, autoCompleteMenu: true })
    .then(async (input) => {
      await runCommand(input, autoComplete, lorena, wallet)
      terminal(lorena, wallet)
    })
}

>>>>>>> 79bfb216e4fecec52344a43a6fab71c7ef81a3ee
main()
